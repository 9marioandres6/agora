<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ project()?.title || 'Project' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  @if (isLoading()) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>{{ 'PROJECT.LOADING' | translate }}</p>
    </div>
  } @else if (project()) {
    <div class="container">
      <!-- Information Section -->
      <ion-card class="project-info">
        <ion-card-content>
          <div class="info-row">
            <div class="info-content">
              @if (isCreator()) {
                <ion-input 
                  [ngModel]="editingProject().title || project()?.title || ''" 
                  (ngModelChange)="updateProjectField('title', $event)"
                  placeholder="{{ 'PROJECT.TITLE_PLACEHOLDER' | translate }}"
                  class="title-input">
                </ion-input>
              } @else {
                <span>{{ project()?.title }}</span>
              }
            </div>
          </div>

          <div class="info-row">
            <div class="info-content">
              <ion-chip color="primary" class="scope-chip">
                <ion-icon [name]="getScopeIcon(project()?.scope || '')"></ion-icon>
                {{ getScopeLabel(project()?.scope || '') }}
              </ion-chip>
              @if (project()?.scope?.place) {
                <ion-chip color="secondary">
                  <ion-icon name="location-outline" slot="start"></ion-icon>
                  {{ project()?.scope?.place }}
                </ion-chip>
              }
              <ion-chip 
                [color]="getStateColor(project()?.state || 'building')"
                class="state-chip" 
                [class.clickable]="isCreator() && canAdvanceState()"
                (click)="isCreator() && canAdvanceState() ? showStateAdvancementModal() : null">
                <ion-icon [name]="getStateIcon(project()?.state || 'building')"></ion-icon>
                {{ getStateLabel(project()?.state || 'building') | translate }}
              </ion-chip>
            </div>
          </div>

          <div class="info-row">
            <div class="info-content">
              @if (isCreator()) {
                <ion-textarea 
                  [ngModel]="editingProject().description || project()?.description || ''" 
                  (ngModelChange)="updateProjectField('description', $event)"
                  placeholder="{{ 'PROJECT.DESCRIPTION_PLACEHOLDER' | translate }}" 
                  rows="8"
                  autoGrow="true"
                  class="description-textarea">
                </ion-textarea>
              } @else {
                <span>{{ project()?.description }}</span>
              }
            </div>
          </div>

          @if (project()?.state === 'implementing') {
          <div class="info-row">
            <div class="info-content">
              <div class="implementation-progress">
                <div class="progress-header">
                  <span class="progress-label">{{ "HOME.IMPLEMENTATION_PROGRESS" | translate }}</span>
                  @if (isCreator()) {
                    <div class="progress-controls">
                      <ion-range
                        [ngModel]="editingProject().implementationPercentage || project()?.implementationPercentage || 0"
                        (ngModelChange)="updateProjectField('implementationPercentage', $event)"
                        min="0"
                        max="100"
                        step="1"
                        color="primary"
                        class="progress-range">
                        <ion-label slot="start">0%</ion-label>
                        <ion-label slot="end">100%</ion-label>
                      </ion-range>
                      <span class="progress-percentage">{{ editingProject().implementationPercentage || project()?.implementationPercentage || 0 }}%</span>
                    </div>
                  } @else {
                    <span class="progress-percentage">{{ project()?.implementationPercentage || 0 }}%</span>
                  }
                </div>
                <ion-progress-bar 
                  [value]="(editingProject().implementationPercentage || project()?.implementationPercentage || 0) / 100" 
                  color="primary"
                  class="progress-bar">
                </ion-progress-bar>
              </div>
            </div>
          </div>
          }

          <div class="info-row">
            <div class="info-content">
              @if (isCreator()) {
                <div class="project-media-editor">
                  @if (!project()?.media?.length) {
                    <ion-button 
                      fill="outline" 
                      size="small" 
                      (click)="showAddProjectMediaModal()"
                      class="add-project-media-btn">
                      <ion-icon name="add" slot="start"></ion-icon>
                      {{ 'CHAPTERS.ADD_MEDIA' | translate }}
                    </ion-button>
                  } @else {
                    <div class="project-media">
                      <div class="media-grid">
                        @for (media of project()?.media || []; track media.id) {
                          <div class="media-item">
                            <div class="media-preview clickable" (click)="replaceProjectMedia()">
                              @if (media.type === 'image') {
                                <img [src]="media.url" [alt]="media.caption" class="media-image">
                              } @else if (media.type === 'video') {
                                <div class="video-thumbnail">
                                  <video [src]="media.url" class="media-video"></video>
                                  <div class="play-overlay">
                                    <ion-icon name="play-circle" size="large"></ion-icon>
                                  </div>
                                </div>
                              }
                            </div>
                            <div class="media-info">
                              <ion-button fill="clear" size="small" color="danger" class="delete-media-btn" (click)="deleteProjectMedia(media)">
                                <ion-icon name="trash-outline"></ion-icon>
                              </ion-button>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                @if (project()?.media?.length) {
                  <div class="project-media">
                    <div class="media-grid">
                      @for (media of project()?.media || []; track media.id) {
                        <div class="media-item">
                          <div class="media-preview">
                            @if (media.type === 'image') {
                              <img [src]="media.url" [alt]="media.caption" class="media-image">
                            } @else if (media.type === 'video') {
                              <div class="video-thumbnail">
                                <video [src]="media.url" class="media-video"></video>
                                <div class="play-overlay">
                                  <ion-icon name="play-circle" size="large"></ion-icon>
                                </div>
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
              }
            </div>
          </div>

          <div class="info-row">
            <div class="info-content">
              @if (isCreator()) {
                @if (canEditNeeds()) {
                  <div class="needs-editor">
                    <!-- Add new need input -->
                    <div class="add-need-section">
                      <ion-input 
                        [(ngModel)]="newNeedText"
                        placeholder="{{ 'PROJECT.NEED_PLACEHOLDER' | translate }}"
                        (keyup.enter)="addNewNeed()"
                        class="new-need-input">
                      </ion-input>
                      <ion-button 
                        fill="outline" 
                        size="small" 
                        (click)="addNewNeed()"
                        [disabled]="!newNeedText.trim()"
                        class="add-need-btn">
                        <ion-icon name="add" slot="start"></ion-icon>
                        {{ 'PROJECT.ADD_NEED' | translate }}
                      </ion-button>
                    </div>
                    
                    <!-- Existing needs list -->
                    @for (need of editingProject().needs || project()?.needs || []; track $index) {
                      <div class="need-item">
                        <ion-chip 
                          [color]="getNeedChipColor(need)"
                          class="need-chip clickable"
                          (click)="toggleNeedState(need)">
                          <ion-icon [name]="getNeedIcon(need)"></ion-icon>
                          <ion-label>{{ getNeedStateText(need) | translate }}</ion-label>
                        </ion-chip>
                        <span class="need-text">{{ need.name }}</span>
                        <ion-button fill="clear" color="danger" size="small" (click)="removeProjectNeed($index)">
                          <ion-icon name="trash-outline"></ion-icon>
                        </ion-button>
                      </div>
                    }
                  </div>
                } @else {
                  <div class="needs-locked">
                    <div class="needs-lock-info">
                      <ion-icon name="lock-closed" class="lock-icon"></ion-icon>
                      <div class="lock-text">
                        <h4>{{ 'PROJECT.NEEDS_LOCKED_TITLE' | translate }}</h4>
                        <p>{{ 'PROJECT.NEEDS_LOCKED_MESSAGE' | translate }}</p>
                        <div class="support-progress">
                          <div class="progress-bar">
                            <div class="progress-fill" [style.width.%]="getNeedsUnlockStatus().progress"></div>
                          </div>
                          <span class="progress-text">
                            {{ getNeedsUnlockStatus().current }}/{{ getNeedsUnlockStatus().required }} {{ 'PROJECT.SUPPORT_VOTES' | translate }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              } @else {
                <div class="needs-display">
                  <div class="needs-list-readonly">
                    @for (need of project()?.needs || []; track need) {
                      <div class="need-item-readonly">
                        <ion-chip 
                          [color]="getNeedChipColor(need)"
                          class="need-chip-readonly">
                          <ion-icon [name]="getNeedIcon(need)"></ion-icon>
                          <ion-label>{{ getNeedStateText(need) | translate }}</ion-label>
                        </ion-chip>
                        <span class="need-text-readonly">{{ need.name }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>

          <div class="info-row">
            <div class="info-content">
              <div class="members-summary" (click)="toggleMembers()">
                <span>
                  {{ getCollaboratorsText() }}
                  <span class="separator"> - </span>
                  <span [class.request-count]="hasPendingRequests()" [class.has-requests]="hasPendingRequests()">
                    {{ getRequestsText() }}
                  </span>
                </span>
                <ion-icon 
                  [name]="membersExpanded() ? 'chevron-up' : 'chevron-down'" 
                  class="expand-icon">
                </ion-icon>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Collapsible Members Section -->
      @if (membersExpanded()) {
        <ion-card class="members-section">
          <ion-card-content>
            <!-- Creator -->
            <div class="member-item creator">
              <app-user-avatar
                [user]="getCreatorData()"
                [variant]="'creator'"
                [avatarSize]="'small'"
                [showRole]="true"
                [clickable]="true"
                [showProjectSummary]="true">
              </app-user-avatar>
            </div>

            <!-- Accepted Collaborators -->
            @for (collaborator of project()?.collaborators || []; track collaborator.uid) {
              <div class="member-item collaborator">
                <app-user-avatar
                  [user]="getCollaboratorData(collaborator)"
                  [variant]="'collaborator'"
                  [avatarSize]="'small'"
                  [showRole]="true"
                  [clickable]="true"
                  [showProjectSummary]="true">
                </app-user-avatar>
              </div>
            }

            <!-- Pending Collaborators Section (Creator Only) -->
            @if (isCreator() && (pendingCollaborators() || []).length > 0) {
              <div class="pending-collaborators-section">
                <h4 class="pending-title">{{ 'PROJECT.PENDING_COLLABORATORS' | translate }}</h4>
                @for (request of pendingCollaborators(); track request.uid) {
                  <div class="pending-item">
                    <div class="request-info">
                      <ion-avatar class="avatar-small">
                        @if (request.photoURL) {
                          <img 
                            [src]="request.photoURL" 
                            appImageFallback
                            [fallbackIcon]="'person'"
                            [fallbackSize]="'small'">
                        } @else {
                          <ion-icon name="person"></ion-icon>
                        }
                      </ion-avatar>
                      <div class="request-details">
                        <h4>{{ request.displayName || 'Anonymous' }}</h4>
                        <p>{{ request.email }}</p>
                        @if (request.message) {
                          <p class="request-message">{{ request.message }}</p>
                        }
                      </div>
                    </div>
                    <div class="request-actions">
                      <ion-button size="small" color="success" (click)="acceptCollaborator(request)">
                        <ion-icon name="checkmark" slot="start"></ion-icon>
                        {{ 'PROJECT.ACCEPT' | translate }}
                      </ion-button>
                      <ion-button size="small" color="danger" fill="outline" (click)="rejectCollaborator(request)">
                        <ion-icon name="close" slot="start"></ion-icon>
                        {{ 'PROJECT.REJECT' | translate }}
                      </ion-button>
                    </div>
                  </div>
                }
              </div>
            }
          </ion-card-content>
        </ion-card>
      }

      <!-- Sections Section -->
      <ion-card class="chapters-section">
        <ion-card-header>
          <div class="section-header">
            <ion-card-title>{{ 'CHAPTERS.TITLE' | translate }}</ion-card-title>
            <ion-button fill="clear" size="small" (click)="showAddChapterModal()" class="add-section-btn">
              <ion-icon name="add" size="large"></ion-icon>
            </ion-button>
          </div>
        </ion-card-header>
        <ion-card-content>
          @for (chapter of project()?.chapters || []; track chapter.id; let i = $index) {
            <div class="chapter-item" [class.clickable]="!isEditingChapter(chapter.id)" (click)="!isEditingChapter(chapter.id) ? editChapter(chapter) : null">
              <div class="chapter-header">
                <div class="chapter-actions">
                  @if (isEditingChapter(chapter.id)) {
                    <ion-button fill="clear" size="small" color="success" (click)="saveChapter(); $event.stopPropagation()">
                      <ion-icon name="checkmark"></ion-icon>
                      Done
                    </ion-button>
                    <ion-button fill="clear" size="small" color="danger" (click)="showDeleteConfirmation(chapter); $event.stopPropagation()">
                      <ion-icon name="trash-outline"></ion-icon>
                      Delete
                    </ion-button>
                  }
                </div>
              </div>
              
              @if (isEditingChapter(chapter.id)) {
                <div class="chapter-editor" (click)="$event.stopPropagation()">
                  <ion-item>
                    <ion-label position="stacked">{{ 'CHAPTERS.OPTIONAL_TITLE' | translate }}</ion-label>
                    <ion-input #chapterTitleInput [(ngModel)]="editingChapter().title" placeholder="{{ 'CHAPTERS.OPTIONAL_TITLE' | translate }}"></ion-input>
                  </ion-item>
                  <ion-item>
                    <ion-label position="stacked">{{ 'CHAPTERS.DESCRIPTION' | translate }}</ion-label>
                    <ion-textarea [(ngModel)]="editingChapter().description" placeholder="{{ 'CHAPTERS.DESCRIPTION' | translate }}" rows="4"></ion-textarea>
                  </ion-item>
                </div>
              } @else {
                <div class="chapter-content">
                  @if (chapter.title) {
                    <h4 class="chapter-title-display">{{ chapter.title }}</h4>
                  }
                  <p class="chapter-description">{{ chapter.description }}</p>
                </div>
              }

              <!-- Section Media -->
              <div class="chapter-media">
                @if (isEditingChapter(chapter.id) && (!chapter.media || chapter.media.length === 0)) {
                  <div class="media-actions" (click)="$event.stopPropagation()">
                    <ion-button fill="outline" size="small" (click)="showAddMediaModal(chapter)">
                      <ion-icon name="add" slot="start"></ion-icon>
                      {{ 'CHAPTERS.ADD_MEDIA' | translate }}
                    </ion-button>
                  </div>
                }
                
                @if ((chapter.media || []).length > 0) {
                  <div class="media-grid">
                    @for (media of chapter.media || []; track media.id) {
                      <div class="media-item">
                        <div class="media-preview" [class.clickable]="isEditingChapter(chapter.id)" (click)="isEditingChapter(chapter.id) ? replaceMedia(chapter) : null">
                          @if (media.type === 'image') {
                            <img [src]="media.url" [alt]="media.caption" class="media-image">
                          } @else if (media.type === 'video') {
                            <div class="video-thumbnail">
                              <video [src]="media.url" class="media-video"></video>
                              <div class="play-overlay">
                                <ion-icon name="play-circle" size="large"></ion-icon>
                              </div>
                            </div>
                          }
                        </div>
                        <div class="media-info">
                          @if (isEditingChapter(chapter.id)) {
                            <ion-button fill="clear" size="small" color="danger" class="delete-media-btn" (click)="deleteMedia(chapter, media)">
                              <ion-icon name="trash-outline"></ion-icon>
                            </ion-button>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </ion-card-content>
      </ion-card>
    </div>
  } @else {
    <div class="error-container">
      <ion-icon name="alert-circle-outline" size="large" color="danger"></ion-icon>
      <h2>{{ 'PROJECT.PROJECT_NOT_FOUND' | translate }}</h2>
      <p>{{ 'PROJECT.PROJECT_NOT_FOUND_MESSAGE' | translate }}</p>
    </div>
  }
</ion-content>
