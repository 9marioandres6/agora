<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ project()?.title || 'Project' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  @if (isLoading()) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>{{ 'PROJECT.LOADING' | translate }}</p>
    </div>
  } @else if (project()) {
    <div class="container">
      <!-- Members Section -->
      <ion-card class="members-section">
        <ion-card-header>
          <ion-card-title>{{ 'PROJECT.MEMBERS' | translate }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Owner -->
          <div class="member-item owner">
            <ion-avatar>
              @if (project()?.creator?.photoURL) {
                <img [src]="project()?.creator?.photoURL" [alt]="project()?.creator?.displayName">
              } @else {
                <ion-icon name="person"></ion-icon>
              }
            </ion-avatar>
            <div class="member-info">
              <h4>{{ project()?.creator?.displayName || 'Anonymous' }}</h4>
              <ion-chip color="primary">{{ 'PROJECT.OWNER' | translate }}</ion-chip>
            </div>
          </div>

          <!-- Accepted Collaborators -->
          @for (collaborator of project()?.collaborators || []; track collaborator.uid) {
            <div class="member-item collaborator">
              <ion-avatar>
                @if (collaborator.photoURL) {
                  <img [src]="collaborator.photoURL" [alt]="collaborator.displayName">
                } @else {
                  <ion-icon name="person"></ion-icon>
                }
              </ion-avatar>
              <div class="member-info">
                <h4>{{ collaborator.displayName || 'Anonymous' }}</h4>
                <ion-chip color="success">{{ 'PROJECT.COLLABORATOR' | translate }}</ion-chip>
              </div>
            </div>
          }
        </ion-card-content>
      </ion-card>

      <!-- Pending Collaborators Section (Owner Only) -->
      @if (isOwner() && (pendingCollaborators() || []).length > 0) {
        <ion-card class="pending-section">
          <ion-card-header>
            <ion-card-title>{{ 'PROJECT.PENDING_COLLABORATORS' | translate }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @for (request of pendingCollaborators(); track request.uid) {
              <div class="pending-item">
                <div class="request-info">
                  <ion-avatar>
                    @if (request.photoURL) {
                      <img [src]="request.photoURL" [alt]="request.displayName">
                    } @else {
                      <ion-icon name="person"></ion-icon>
                    }
                  </ion-avatar>
                  <div class="request-details">
                    <h4>{{ request.displayName || 'Anonymous' }}</h4>
                    <p>{{ request.email }}</p>
                    @if (request.message) {
                      <p class="request-message">{{ request.message }}</p>
                    }
                  </div>
                </div>
                <div class="request-actions">
                  <ion-button size="small" color="success" (click)="acceptCollaborator(request)">
                    <ion-icon name="checkmark" slot="start"></ion-icon>
                    {{ 'PROJECT.ACCEPT' | translate }}
                  </ion-button>
                  <ion-button size="small" color="danger" fill="outline" (click)="rejectCollaborator(request)">
                    <ion-icon name="close" slot="start"></ion-icon>
                    {{ 'PROJECT.REJECT' | translate }}
                  </ion-button>
                </div>
              </div>
            }
          </ion-card-content>
        </ion-card>
      }

      <!-- Information Section -->
      <ion-card class="project-info">
        <ion-card-header>
        </ion-card-header>
        <ion-card-content>
          <div class="info-row">
            <label>{{ 'PROJECT.TITLE_LABEL' | translate }}</label>
            <div class="info-content">
              @if (isOwner()) {
                <ion-input 
                  [ngModel]="editingProject().title || project()?.title || ''" 
                  (ngModelChange)="updateProjectField('title', $event)"
                  placeholder="{{ 'PROJECT.TITLE_PLACEHOLDER' | translate }}">
                </ion-input>
              } @else {
                <span>{{ project()?.title }}</span>
              }
            </div>
          </div>

          <div class="info-row">
            <label>{{ 'PROJECT.SCOPE_LABEL' | translate }}</label>
            <div class="info-content">
              @if (isOwner()) {
                <ion-select 
                  [ngModel]="editingProject().scope || project()?.scope || ''" 
                  (ngModelChange)="updateProjectField('scope', $event)"
                  placeholder="Select scope">
                  <ion-select-option value="grupal">Grupal - Small Group Collaboration</ion-select-option>
                  <ion-select-option value="local">Local - Neighbourhood/Community</ion-select-option>
                  <ion-select-option value="state">State - State/Province level</ion-select-option>
                  <ion-select-option value="national">National - Country level</ion-select-option>
                  <ion-select-option value="global">Global - International level</ion-select-option>
                </ion-select>
              } @else {
                <ion-chip color="primary">{{ getScopeLabel(project()?.scope || '') }}</ion-chip>
              }
            </div>
          </div>

          <div class="info-row">
            <label>{{ 'PROJECT.DESCRIPTION_LABEL' | translate }}</label>
            <div class="info-content">
              @if (isOwner()) {
                <ion-textarea 
                  [ngModel]="editingProject().description || project()?.description || ''" 
                  (ngModelChange)="updateProjectField('description', $event)"
                  placeholder="{{ 'PROJECT.DESCRIPTION_PLACEHOLDER' | translate }}" 
                  rows="3">
                </ion-textarea>
              } @else {
                <span>{{ project()?.description }}</span>
              }
            </div>
          </div>

          <div class="info-row">
            <label>{{ 'PROJECT.NEEDS_LABEL' | translate }}</label>
            <div class="info-content">
              @if (isOwner()) {
                <div class="needs-editor">
                  @for (need of editingProject().needs || project()?.needs || []; track $index) {
                    <div class="need-item">
                      <ion-input 
                        [ngModel]="need"
                        (ngModelChange)="updateProjectNeed($index, $event)"
                        placeholder="{{ 'PROJECT.NEED_PLACEHOLDER' | translate }}"
                        (ionBlur)="saveProjectField('needs')"
                        (keyup.enter)="saveProjectField('needs')">
                      </ion-input>
                      <ion-button fill="clear" color="danger" size="small" (click)="removeProjectNeed($index)">
                        <ion-icon name="trash-outline"></ion-icon>
                      </ion-button>
                    </div>
                  }
                  <ion-button fill="outline" size="small" (click)="addProjectNeed()">
                    <ion-icon name="add" slot="start"></ion-icon>
                    {{ 'PROJECT.ADD_NEED' | translate }}
                  </ion-button>
                </div>
              } @else {
                <div class="needs-display">
                  @for (need of project()?.needs || []; track need) {
                    <ion-chip color="primary" outline>{{ need }}</ion-chip>
                  }
                </div>
              }
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Sections Section -->
      <ion-card class="chapters-section">
        <ion-card-header>
          <div class="section-header">
            <ion-card-title>{{ 'CHAPTERS.TITLE' | translate }}</ion-card-title>
            <ion-button fill="clear" size="small" (click)="showAddChapterModal()" class="add-section-btn">
              <ion-icon name="add" size="large"></ion-icon>
            </ion-button>
          </div>
        </ion-card-header>
        <ion-card-content>
          @for (chapter of project()?.chapters || []; track chapter.id; let i = $index) {
            <div class="chapter-item" [class.clickable]="!isEditingChapter(chapter.id)" (click)="!isEditingChapter(chapter.id) ? editChapter(chapter) : null">
              <div class="chapter-header">
                <div class="chapter-title">
                  @if (chapter.title) {
                    <h3>{{ chapter.title }}</h3>
                  }
                  <p class="chapter-subtitle">{{ 'CHAPTERS.CHAPTER' | translate }} {{ i + 1 }}</p>
                </div>
                <div class="chapter-actions">
                  @if (isEditingChapter(chapter.id)) {
                    <ion-button fill="clear" size="small" color="success" (click)="saveChapter(); $event.stopPropagation()">
                      <ion-icon name="checkmark"></ion-icon>
                      Done
                    </ion-button>
                    <ion-button fill="clear" size="small" color="danger" (click)="showDeleteConfirmation(chapter); $event.stopPropagation()">
                      <ion-icon name="trash-outline"></ion-icon>
                      Delete
                    </ion-button>
                  }
                </div>
              </div>
              
              @if (isEditingChapter(chapter.id)) {
                <div class="chapter-editor" (click)="$event.stopPropagation()">
                  <ion-item>
                    <ion-label position="stacked">{{ 'CHAPTERS.OPTIONAL_TITLE' | translate }}</ion-label>
                    <ion-input #chapterTitleInput [(ngModel)]="editingChapter().title" placeholder="{{ 'CHAPTERS.OPTIONAL_TITLE' | translate }}"></ion-input>
                  </ion-item>
                  <ion-item>
                    <ion-label position="stacked">{{ 'CHAPTERS.DESCRIPTION' | translate }}</ion-label>
                    <ion-textarea [(ngModel)]="editingChapter().description" placeholder="{{ 'CHAPTERS.DESCRIPTION' | translate }}" rows="4"></ion-textarea>
                  </ion-item>
                </div>
              } @else {
                <div class="chapter-content">
                  @if (chapter.title) {
                    <h4 class="chapter-title-display">{{ chapter.title }}</h4>
                  }
                  <p class="chapter-description">{{ chapter.description }}</p>
                </div>
              }

              <!-- Section Media -->
              <div class="chapter-media">
                @if (isEditingChapter(chapter.id) && (!chapter.media || chapter.media.length === 0)) {
                  <div class="media-actions" (click)="$event.stopPropagation()">
                    <ion-button fill="outline" size="small" (click)="showAddMediaModal(chapter)">
                      <ion-icon name="add" slot="start"></ion-icon>
                      {{ 'CHAPTERS.ADD_MEDIA' | translate }}
                    </ion-button>
                  </div>
                }
                
                @if ((chapter.media || []).length > 0) {
                  <div class="media-grid">
                    @for (media of chapter.media || []; track media.id) {
                      <div class="media-item">
                        <div class="media-preview" [class.clickable]="isEditingChapter(chapter.id)" (click)="isEditingChapter(chapter.id) ? replaceMedia(chapter) : null">
                          @if (media.type === 'image') {
                            <img [src]="media.url" [alt]="media.caption" class="media-image">
                          } @else if (media.type === 'video') {
                            <div class="video-thumbnail">
                              <video [src]="media.url" class="media-video"></video>
                              <div class="play-overlay">
                                <ion-icon name="play-circle" size="large"></ion-icon>
                              </div>
                            </div>
                          }
                        </div>
                        <div class="media-info">
                          @if (isEditingChapter(chapter.id)) {
                            <ion-button fill="clear" size="small" color="danger" class="delete-media-btn" (click)="deleteMedia(chapter, media)">
                              <ion-icon name="trash-outline"></ion-icon>
                            </ion-button>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </ion-card-content>
      </ion-card>
    </div>
  } @else {
    <div class="error-container">
      <ion-icon name="alert-circle-outline" size="large" color="danger"></ion-icon>
      <h2>{{ 'PROJECT.PROJECT_NOT_FOUND' | translate }}</h2>
      <p>{{ 'PROJECT.PROJECT_NOT_FOUND_MESSAGE' | translate }}</p>
    </div>
  }
</ion-content>
